{% extends "base.html" %}

{% block title %}Processing - HealthVerify AI{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-4">Processing Providers</h1>
    
    <div class="bg-white rounded-lg shadow-lg p-8">
        <div id="processingStatus">
            <!-- Processing Animation -->
            <div class="text-center mb-6">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
            
            <!-- Progress Information -->
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span class="font-semibold">Status</span>
                    <span id="statusText" class="text-blue-600">Initializing...</span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="font-semibold">Time Elapsed</span>
                    <span id="timeElapsed" class="text-blue-600">0:00</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="text-center mt-2">
                    <span id="progressText" class="text-sm text-gray-600">0%</span>
                </div>
            </div>

            <!-- Current Operation -->
            <div class="text-center mb-6">
                <p id="currentOperation" class="text-gray-700">Preparing to process file...</p>
            </div>

            <!-- Processing Stats -->
            <div class="grid md:grid-cols-3 gap-4 mt-6">
                <div class="text-center p-4 bg-green-50 rounded">
                    <div class="text-2xl font-bold text-green-600" id="successCount">0</div>
                    <div class="text-sm text-gray-600">Successful</div>
                </div>
                <div class="text-center p-4 bg-red-50 rounded">
                    <div class="text-2xl font-bold text-red-600" id="errorCount">0</div>
                    <div class="text-sm text-gray-600">Errors</div>
                </div>
                <div class="text-center p-4 bg-yellow-50 rounded">
                    <div class="text-2xl font-bold text-yellow-600" id="warningCount">0</div>
                    <div class="text-sm text-gray-600">Warnings</div>
                </div>
            </div>

            <!-- File Information -->
            <div class="mt-6 p-4 bg-gray-50 rounded">
                <h3 class="font-semibold mb-2">File Information</h3>
                <div id="fileInfo" class="text-sm text-gray-600">
                    <p id="fileName">Filename: -</p>
                    <p id="fileFormat">Format: -</p>
                    <p id="fileSize">Size: -</p>
                </div>
            </div>
            
            <div class="mt-8" id="errorLog">
                <!-- Error messages will be dynamically added here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

function updateProgress() {
    fetch(`/status/{{ job_id }}`)
        .then(response => response.json())
        .then(data => {
            // Update progress bar and text
            const progress = data.progress || 0;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
            
            // Update status and operation
            document.getElementById('statusText').textContent = data.status;
            document.getElementById('currentOperation').textContent = data.message;
            
            // Update timer
            document.getElementById('timeElapsed').textContent = formatTime(data.processing_time);
            
            // Update counters if available
            if (data.counters) {
                document.getElementById('successCount').textContent = data.counters.success || 0;
                document.getElementById('errorCount').textContent = data.counters.errors || 0;
                document.getElementById('warningCount').textContent = data.counters.warnings || 0;
            }
            
            // Handle completion
            if (data.status === 'completed') {
                window.location.href = `/results/{{ job_id }}`;
            }
            // Handle failure
            else if (data.status === 'failed') {
                document.getElementById('statusText').textContent = 'Error';
                document.getElementById('statusText').classList.add('text-red-600');
                document.getElementById('currentOperation').textContent = data.message;
                document.getElementById('currentOperation').classList.add('text-red-600');
            }
            // Continue polling if still processing
            else {
                setTimeout(updateProgress, 1000);
            }
        })
        .catch(error => {
            console.error('Error fetching status:', error);
            setTimeout(updateProgress, 1000);
        });
}

// Start polling when page loads
document.addEventListener('DOMContentLoaded', () => {
    updateProgress();
});
</script>
{% endblock %}